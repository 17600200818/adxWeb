<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>卖方用户</title>

    <meta name="description" content="Static &amp; Dynamic Tables" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="__PUBLIC__/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/font-awesome.min.css" />
    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="__PUBLIC__/assets/css/chosen.css" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/jquery-ui.min.css" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/datepicker.css" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/ui.jqgrid.css" />
    <!-- text fonts -->
    <link rel="stylesheet" href="__PUBLIC__/assets/css/ace-fonts.css" />
    <!-- ace styles -->
    <link rel="stylesheet" href="__PUBLIC__/assets/css/ace.min.css" id="main-ace-style" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/ace-skins.min.css" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/ace-rtl.min.css" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/page.css" />
    <!-- ace settings handler -->
    <script src="__PUBLIC__/assets/js/ace-extra.min.js"></script>
    <script type="text/javascript">
        window.jQuery || document.write("<script src='__PUBLIC__/assets/js/jquery.min.js'>"+"<"+"/script>");
    </script>
    <script src="__PUBLIC__/assets/js/bootstrap.min.js"></script>
    <!-- page specific plugin scripts -->
    <script src="__PUBLIC__/assets/js/date-time/bootstrap-datepicker.min.js"></script>
    <script src="__PUBLIC__/assets/js/jqGrid/jquery.jqGrid.min.js"></script>
    <script src="__PUBLIC__/assets/js/jqGrid/i18n/grid.locale-en.js"></script>
    <!-- ace scripts -->
    <script src="__PUBLIC__/assets/js/ace-elements.min.js"></script>
    <script src="__PUBLIC__/assets/js/ace.min.js"></script>
    <link rel="stylesheet" href="__PUBLIC__/assets/css/ace.onpage-help.css" />
    <script src="__PUBLIC__/assets/js/jquery.page.js"></script>
</head>

<body class="no-skin">
<!-- #section:basics/navbar.layout -->
<div id="navbar" class="navbar navbar-default">
    <script type="text/javascript">
        try{ace.settings.check('navbar' , 'fixed')}catch(e){}
    </script>

    <!-- /.navbar-container -->
    <!-- 头部 -->
    <include file="Common/head"/>
</div>

<!-- /section:basics/navbar.layout -->
<div class="main-container" id="main-container">
    <script type="text/javascript">
        try{ace.settings.check('main-container' , 'fixed')}catch(e){}
    </script>

    <!-- #section:basics/sidebar -->
    <!-- 导航条 -->
    <include file="Common/navigation"/>
    <!-- /section:basics/sidebar -->

    <!-- 正文 -->
    <div class="main-content">
        <!-- #section:basics/content.breadcrumbs -->
        <div class="breadcrumbs" id="breadcrumbs">
            <script type="text/javascript">
                try{ace.settings.check('breadcrumbs' , 'fixed')}catch(e){}
            </script>

            <ul class="breadcrumb">
                <li>
                    <i class="ace-icon fa fa-home home-icon"></i>
                    <a href="#">账户管理</a>
                </li>

                <li class="active">媒体账户</li>
            </ul><!-- /.breadcrumb -->

            <!-- #section:basics/content.searchbox -->
            <div class="nav-search" id="nav-search">

            </div><!-- /.nav-search -->

            <!-- /section:basics/content.searchbox -->
        </div>

        <!-- /section:basics/content.breadcrumbs -->
        <div class="page-content">
            <!-- /section:settings.box -->
            <div class="page-content-area">

                <div class="row" style="height:50px;">
                    <div class="col-xs-2">
                        <input type="text" placeholder="邮箱" class="searchInp" id="Email" />
                    </div>
                    <div class="col-xs-2">
                        <div>
                            <select id="Status" style="width: 100%" class="searchSel" >
                                <option value=""> 全部状态 </option>
                                <option value="2"> 正常 </option>
                                <option value="4"> 停用 </option>
                            </select>
                        </div>
                    </div>
                    <div class="col-xs-6">

                    </div>
                    <div class="col-xs-2" style="text-align:right;">
                        <a href="/agentSeller/add/parentId/{$parentId}">
                            <button type="button" class="btn btn-sm btn-success">
                                添加
                                <i class="glyphicon glyphicon-plus"></i>
                            </button>
                        </a>
                    </div>
                </div>
                <div class="row" style="float:left">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->

                        <table id="grid-table"></table>

                        <div id="grid-pager"></div>

                        <script type="text/javascript">
                            var $path_base = "..";//in Ace demo this will be used for editurl parameter
                        </script>

                        <!-- PAGE CONTENT ENDS -->
                    </div><!-- /.col -->


                </div><!-- /.row -->

            </div><!-- /.page-content-area -->
        </div><!-- /.page-content -->
    </div><!-- /.main-content -->
    <!-- 正文结束 -->

    <!-- 尾部 -->
    <include file="Common/footer"/>
    <input type="hidden" id="ParentId" value="{$parentId}">
    <input type="hidden" id="sellerId">
    <!--重置密码-->
    <div class="modal fade" id="pwdReset" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-hidden="true">×
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        重置密码
                    </h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form">
                        <!-- #section:elements.form -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right" > 原密码 </label>

                            <div class="col-sm-9">
                                <input type="password" id="pwd" placeholder="原密码" class="form-control" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right" > 新密码 </label>

                            <div class="col-sm-9">
                                <input type="password" id="newPwd" placeholder="新密码" class="form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right" > 确认新密码 </label>

                            <div class="col-sm-9">
                                <input type="password" id="confirmNewPwd" placeholder="确认新密码" class="form-control" />
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal" id="subPwd">修改
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>

    <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
        <i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
    </a>
</div><!-- /.main-container -->

<!-- inline scripts related to this page -->
<script type="text/javascript">
jQuery(function($) {
    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";

    //resize to fit page size
    $(window).on('resize.jqGrid', function () {
        $(grid_selector).jqGrid( 'setGridWidth', $(".page-content").width() );
    })
    //resize on sidebar collapse/expand
    var parent_column = $(grid_selector).closest('[class*="col-"]');
    $(document).on('settings.ace.jqGrid' , function(ev, event_name, collapsed) {
        if( event_name === 'sidebar_collapsed' || event_name === 'main_container_fixed' ) {
            //setTimeout is for webkit only to give time for DOM changes and then redraw!!!
            setTimeout(function() {
                $(grid_selector).jqGrid( 'setGridWidth', parent_column.width() );
            }, 0);
        }
    })

    jQuery(grid_selector).jqGrid({

        //direction: "rtl",
        //subgrid options
        subGrid : false,
        //subGridModel: [{ name : ['No','Item Name','Qty'], width : [55,200,80] }],
        //datatype: "xml",
        subGridOptions : {
            plusicon : "ace-icon fa fa-plus center bigger-110 blue",
            minusicon  : "ace-icon fa fa-minus center bigger-110 blue",
            openicon : "ace-icon fa fa-chevron-right center orange"
        },
        url:"/agentSeller/index",
        datatype: 'json',
        mtype: 'POST',
        postData: {parentId:$('#ParentId').val()},
        height: 370,
        colNames:['id', '账户名称','联系人', '手机号码', '最后登陆IP','状态','操作'],
        colModel:[
            {name:'id',index:'id', width:60, sorttype:"int", editable: false},
            {name:'email',index:'email', width:120,editable: false,editoptions:{size:"20",maxlength:"30"}},
            {name:'linkman',index:'linkman',sortable: false, width:120,editable: false,editoptions:{size:"20",maxlength:"30"}},
            {name:'mobiletel',index:'mobiletel', width:160, editable:false, sorttype:"date",unformat: pickDate},
            {name:'lastloginipaddr',index:'lastloginipaddr',width:120, editable:false, sorttype:"date",unformat: pickDate},
            {name:'status', width : 80, index : 'id',  align: 'center',editable:true,editoptions:{size:10},formatter:statusButton},
            {
                name: 'myac', index: '', width:200, fixed: true, sortable: false, resize: false,
                formatter: function (value, grid, rows, state) {
                    if({$isAllow} == 1) {
                        var edit = '<a href="/seller/edit/id/'+rows.id+'"><button type="button" class="btn btn-xs btn-success">修改</button></a> ';
                    }else {
                        var edit = '';
                    }
                    if(rows.idrole == 2){return edit+'<a href="#"><button data-toggle="modal"  data-target="#pwdReset" type="button" class="btn btn-xs btn-warning" onclick="pwdDiv('+rows.id+')">重置密码</button></a> <a href="/agentSeller/index/id/'+rows.id+'"><button type="button" class="btn btn-xs btn-success">媒体列表</button></a>'}else{return edit+'<a href="#"><button data-toggle="modal"  data-target="#pwdReset" type="button" class="btn btn-xs btn-warning" onclick="pwdDiv('+rows.id+')">重置密码</button></a>'}
                }
            }
        ],

        viewrecords : true,
        rowNum:10,
        rowList:[10,20,30],
        pager : pager_selector,
        altRows: true,
        //toppager: true,

        multiselect: false,
        //multikey: "ctrlKey",
        multiboxonly: true,

        loadComplete : function() {
            var table = this;
            setTimeout(function(){
                styleCheckbox(table);

                updateActionIcons(table);
                updatePagerIcons(table);
                enableTooltips(table);
            }, 0);
        },

        editurl: "/seller/edit",//nothing is saved
        caption: "",
        autowidth: true,
        jsonReader: {
            repeatitems : false,
            root:"data"
        }
        /**
         ,
         grouping:true,
         groupingView : {
						 groupField : ['name'],
						 groupDataSorted : true,
						 plusicon : 'fa fa-chevron-down bigger-110',
						 minusicon : 'fa fa-chevron-up bigger-110'
					},
         caption: "Grouping"
         */

    });
    $(window).triggerHandler('resize.jqGrid');//trigger window resize to make the grid get the correct size



    //enable search/filter toolbar
    //jQuery(grid_selector).jqGrid('filterToolbar',{defaultSearch:true,stringResult:true})
    //jQuery(grid_selector).filterToolbar({});


    //switch element when editing inline
    function aceSwitch( cellvalue, options, cell ) {
        setTimeout(function(){
            $(cell) .find('input[type=checkbox]')
                .addClass('ace ace-switch ace-switch-5')
                .after('<span class="lbl"></span>');
        }, 0);
    }
    //enable datepicker
    function pickDate( cellvalue, options, cell ) {
        setTimeout(function(){
            $(cell) .find('input[type=text]')
                .datepicker({format:'yyyy-mm-dd' , autoclose:true});
        }, 0);
    }

    function statusButton(cellvalue, options, rowObject){
        var id=rowObject.id;
        var statusButton="";
        if({$isSetStatus} == 1) {
            var edit = '';
        }else {
            var edit = 'onclick="return false;"';
        }

        if(rowObject.status == 2){
            statusButton = '<div class="col-xs-3"><label><input checked name="switch-field-1" class="ace ace-switch ace-switch-4 btn-rotate" '+edit+' onchange="setStatus('+id+')" type="checkbox"><span class="lbl"></span></label></div>';
        }else{
            statusButton = '<div class="col-xs-3"><label><input name="switch-field-1" class="ace ace-switch ace-switch-4 btn-rotate" '+edit+' onchange="setStatus('+id+')" type="checkbox"><span class="lbl"></span></label></div>';
        }

        return statusButton;
    }

    //navButtons
    jQuery(grid_selector).jqGrid('navGrid',pager_selector,
        { 	//navbar options
            edit: false,
            editicon : 'ace-icon fa fa-pencil blue',
            add: false,
            addicon : 'ace-icon fa fa-plus-circle purple',
            del: false,
            delicon : 'ace-icon fa fa-trash-o red',
            search: false,
            searchicon : 'ace-icon fa fa-search orange',
            refresh: false,
            refreshicon : 'ace-icon fa fa-refresh green',
            view: false,
            viewicon : 'ace-icon fa fa-search-plus grey',
        },
        {
            //edit record form
            //closeAfterEdit: true,
            //width: 700,
            recreateForm: false,
            beforeShowForm : function(e) {
                var form = $(e[0]);
                form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
                style_edit_form(form);
            }
        },
        {
            //new record form
            //width: 700,
            closeAfterAdd: true,
            recreateForm: true,
            viewPagerButtons: false,
            beforeShowForm : function(e) {
                var form = $(e[0]);
                form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar')
                    .wrapInner('<div class="widget-header" />')
                style_edit_form(form);
            }
        },
        {
            //delete record form
            recreateForm: true,
            beforeShowForm : function(e) {
                var form = $(e[0]);
                if(form.data('styled')) return false;

                form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
                style_delete_form(form);

                form.data('styled', true);
            },
            onClick : function(e) {
                alert(1);
            }
        },
        {
            //search form
            recreateForm: true,
            afterShowSearch: function(e){
                var form = $(e[0]);
                form.closest('.ui-jqdialog').find('.ui-jqdialog-title').wrap('<div class="widget-header" />')
                style_search_form(form);
            },
            afterRedraw: function(){
                style_search_filters($(this));
            }
            ,
            multipleSearch: true,
            /**
             multipleGroup:true,
             showQuery: true
             */
        },
        {
            //view record form
            recreateForm: true,
            beforeShowForm: function(e){
                var form = $(e[0]);
                form.closest('.ui-jqdialog').find('.ui-jqdialog-title').wrap('<div class="widget-header" />')
            }
        }
    )

    function style_edit_form(form) {
        //enable datepicker on "sdate" field and switches for "stock" field
        form.find('input[name=sdate]').datepicker({format:'yyyy-mm-dd' , autoclose:true})
            .end().find('input[name=stock]')
            .addClass('ace ace-switch ace-switch-5').after('<span class="lbl"></span>');
        //don't wrap inside a label element, the checkbox value won't be submitted (POST'ed)
        //.addClass('ace ace-switch ace-switch-5').wrap('<label class="inline" />').after('<span class="lbl"></span>');

        //update buttons classes
        var buttons = form.next().find('.EditButton .fm-button');
        buttons.addClass('btn btn-sm').find('[class*="-icon"]').hide();//ui-icon, s-icon
        buttons.eq(0).addClass('btn-primary').prepend('<i class="ace-icon fa fa-check"></i>');
        buttons.eq(1).prepend('<i class="ace-icon fa fa-times"></i>')

        buttons = form.next().find('.navButton a');
        buttons.find('.ui-icon').hide();
        buttons.eq(0).append('<i class="ace-icon fa fa-chevron-left"></i>');
        buttons.eq(1).append('<i class="ace-icon fa fa-chevron-right"></i>');
    }

    function style_delete_form(form) {
        var buttons = form.next().find('.EditButton .fm-button');
        buttons.addClass('btn btn-sm btn-white btn-round').find('[class*="-icon"]').hide();//ui-icon, s-icon
        buttons.eq(0).addClass('btn-danger').prepend('<i class="ace-icon fa fa-trash-o"></i>');
        buttons.eq(1).addClass('btn-default').prepend('<i class="ace-icon fa fa-times"></i>');
    }

    function style_search_filters(form) {
        form.find('.delete-rule').val('X');
        form.find('.add-rule').addClass('btn btn-xs btn-primary');
        form.find('.add-group').addClass('btn btn-xs btn-success');
        form.find('.delete-group').addClass('btn btn-xs btn-danger');
    }
    function style_search_form(form) {
        var dialog = form.closest('.ui-jqdialog');
        var buttons = dialog.find('.EditTable')
        buttons.find('.EditButton a[id*="_reset"]').addClass('btn btn-sm btn-info').find('.ui-icon').attr('class', 'ace-icon fa fa-retweet');
        buttons.find('.EditButton a[id*="_query"]').addClass('btn btn-sm btn-inverse').find('.ui-icon').attr('class', 'ace-icon fa fa-comment-o');
        buttons.find('.EditButton a[id*="_search"]').addClass('btn btn-sm btn-purple').find('.ui-icon').attr('class', 'ace-icon fa fa-search');
    }

    function beforeDeleteCallback(e) {
        var form = $(e[0]);
        if(form.data('styled')) return false;

        form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
        style_delete_form(form);

        form.data('styled', true);
    }

    function beforeEditCallback(e) {
        console.log(e);
        var form = $(e[0]);
        form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
        style_edit_form(form);
    }
    //it causes some flicker when reloading or navigating grid
    //it may be possible to have some custom formatter to do this as the grid is being created to prevent this
    //or go back to default browser checkbox styles for the grid

    function search() {
        var email = $('#Email').val();
        var status = $('#Status').val();
        var idRole = $('#Role').val();
        var parentId = $('#ParentId').val();

        jQuery(grid_selector).jqGrid('setGridParam',{
            datatype:'json',
            postData: {
                'email': email,
                'status':status,
                'idRole':idRole,
                'parentId':parentId,
            }, //发送数据
            page:1
        }).trigger("reloadGrid"); //重新载入
    }

    $('.searchInp').blur(function () {
        search();
    });

    $('.searchSel').change(function () {
        search();
    });

    function styleCheckbox(table) {
        /**
         $(table).find('input:checkbox').addClass('ace')
         .wrap('<label />')
         .after('<span class="lbl align-top" />')


         $('.ui-jqgrid-labels th[id*="_cb"]:first-child')
         .find('input.cbox[type=checkbox]').addClass('ace')
         .wrap('<label />').after('<span class="lbl align-top" />');
         */
    }


    //unlike navButtons icons, action icons in rows seem to be hard-coded
    //you can change them like this in here if you want
    function updateActionIcons(table) {
        /**
         var replacement =
         {
             'ui-ace-icon fa fa-pencil' : 'ace-icon fa fa-pencil blue',
             'ui-ace-icon fa fa-trash-o' : 'ace-icon fa fa-trash-o red',
             'ui-icon-disk' : 'ace-icon fa fa-check green',
             'ui-icon-cancel' : 'ace-icon fa fa-times red'
         };
         $(table).find('.ui-pg-div span.ui-icon').each(function(){
						var icon = $(this);
						var $class = $.trim(icon.attr('class').replace('ui-icon', ''));
						if($class in replacement) icon.attr('class', 'ui-icon '+replacement[$class]);
					})
         */
    }

    //replace icons with FontAwesome icons like above
    function updatePagerIcons(table) {
        var replacement =
        {
            'ui-icon-seek-first' : 'ace-icon fa fa-angle-double-left bigger-140',
            'ui-icon-seek-prev' : 'ace-icon fa fa-angle-left bigger-140',
            'ui-icon-seek-next' : 'ace-icon fa fa-angle-right bigger-140',
            'ui-icon-seek-end' : 'ace-icon fa fa-angle-double-right bigger-140'
        };
        $('.ui-pg-table:not(.navtable) > tbody > tr > .ui-pg-button > .ui-icon').each(function(){
            var icon = $(this);
            var $class = $.trim(icon.attr('class').replace('ui-icon', ''));

            if($class in replacement) icon.attr('class', 'ui-icon '+replacement[$class]);
        })
    }

    function enableTooltips(table) {
        $('.navtable .ui-pg-button').tooltip({container:'body'});
        $(table).find('.ui-pg-div').tooltip({container:'body'});
    }

    //var selr = jQuery(grid_selector).jqGrid('getGridParam','selrow');

    $(document).on('ajaxloadstart', function(e) {
        $(grid_selector).jqGrid('GridUnload');
        $('.ui-jqdialog').remove();
    });

    $('.date-picker').datepicker({
        autoclose: true,
        todayHighlight: true
    })

});

function setStatus($id) {
    $.post('/seller/setStatus', {'id' : $id}, function (result) {
        return;
    })
}

function pwdDiv($id) {
    $("#sellerId").val($id);
}

$('#subPwd').click(function () {
    var id = $('#sellerId').val();
    var pwd = $('#pwd').val();
    var newPwd = $('#newPwd').val();
    var confirmNewPwd = $('#confirmNewPwd').val();
    $.post('/seller/setPwd', {'id' : id, 'pwd' : pwd, 'newPwd' : newPwd, 'confirmNewPwd' : confirmNewPwd}, function (result) {
        alert(result.msg);
    })
});

</script>
</body>
</html>
